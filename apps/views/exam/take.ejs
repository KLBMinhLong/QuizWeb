<%- include("../partical/header", { title: "L√†m b√†i" }) %>

<!-- Breadcrumb (US-41) -->
<nav class="breadcrumb">
  <a href="/" class="breadcrumb__item">Trang ch·ªß</a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <a href="/subjects" class="breadcrumb__item">M√¥n h·ªçc</a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <% if (subject && subject.slug) { %>
  <a href="/subjects/<%= subject.slug %>" class="breadcrumb__item"><%= subject.name %></a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <% } %>
  <span class="breadcrumb__item breadcrumb__item--current">L√†m b√†i</span>
</nav>

<div class="page-header">
  <h1 class="page-title">L√†m b√†i<% if (subject && subject.name) { %>: <%= subject.name %><% } %></h1>
</div>

<% if (hasShortage) { %>
<div class="alert alert-warning" style="margin-bottom: var(--spacing-xl);">
  ‚ö†Ô∏è Ng√¢n h√†ng c√¢u h·ªèi hi·ªán kh√¥ng ƒë·ªß theo c·∫•u h√¨nh ƒë·ªÅ. H·ªá th·ªëng ƒë√£ l·∫•y t·ªëi ƒëa s·ªë c√¢u c√≥ th·ªÉ cho m·ªói ƒë·ªô kh√≥.
</div>
<% } %>

<% if (!questions || questions.length === 0) { %>
<div class="card">
  <p>Ch∆∞a ƒë·ªß c√¢u h·ªèi trong ng√¢n h√†ng cho m√¥n n√†y.</p>
</div>
<% } else { %>

<!-- Timer (US-41) -->
<div id="exam-timer" class="exam-timer">
  <div class="exam-timer-content">
    <span class="exam-timer-label">‚è±Ô∏è Th·ªùi gian c√≤n l·∫°i:</span>
    <span id="exam-timer-text" class="exam-timer-text">00:00</span>
  </div>
  <div id="exam-timer-warning" class="exam-timer-warning" style="display: none;">
    Th·ªùi gian s·∫Øp h·∫øt! H√£y n·ªôp b√†i s·ªõm.
  </div>
</div>

<form 
  id="exam-form" 
  method="post" 
  action="/exam/submit" 
  class="card"
  data-duration-minutes="<%= durationMinutes %>"
  data-attempt-id="<%= attemptId %>"
  data-total-questions="<%= questions.length %>"
>
  <input type="hidden" name="subjectId" value="<%= subjectId %>" />
  <input type="hidden" name="attemptId" value="<%= attemptId %>" />

  <% questions.forEach(function(q, idx){ %>
  <div class="exam-question" data-question-type="<%= q.type %>" data-question-id="<%= q._id %>">
    <div class="exam-question-header">
      <span class="badge">C√¢u <%= idx + 1 %></span>
    </div>

    <!-- H∆∞·ªõng d·∫´n ng·∫Øn cho t·ª´ng lo·∫°i c√¢u h·ªèi -->
    <div class="exam-question-hint">
      <% 
        const hints = {
          'single_choice': 'Ch·ªçn m·ªôt ƒë√°p √°n ƒë√∫ng',
          'multiple_choice': 'Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu ƒë√°p √°n ƒë√∫ng',
          'true_false': 'Ch·ªçn ƒê√∫ng ho·∫∑c Sai',
          'fill_in_blank': 'Nh·∫≠p ƒë√°p √°n v√†o √¥ tr·ªëng',
          'matching': 'N·ªëi m·ªói m·ª•c b√™n tr√°i v·ªõi m·ª•c t∆∞∆°ng ·ª©ng b√™n ph·∫£i'
        };
        const hint = hints[q.type] || 'Tr·∫£ l·ªùi c√¢u h·ªèi';
      %>
      <span class="exam-question-hint-text">üí° <%= hint %></span>
    </div>

    <div class="exam-question-content"><%= q.content %></div>

    <% if (q.mediaUrl) { %>
    <div class="exam-question-media">
      <% if (q.mediaUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) { %>
      <img src="<%= q.mediaUrl %>" alt="Media" class="exam-media-image" />
      <% } else if (q.mediaUrl.match(/\.(mp4|webm|ogg)$/i)) { %>
      <video src="<%= q.mediaUrl %>" controls class="exam-media-video">
        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
      </video>
      <% } else { %>
      <div class="exam-media-link">
        <a href="<%= q.mediaUrl %>" target="_blank">M·ªü media</a>
      </div>
      <% } %>
    </div>
    <% } %>

    <!-- Single Choice -->
    <% if (q.type === 'single_choice' && Array.isArray(q.answers)) { %>
    <div class="exam-question-options">
      <% q.answers.forEach(function(a, answerIndex){ %>
      <label class="exam-option">
        <input
          type="radio"
          name="answers[<%= q._id %>]"
          value="<%= answerIndex %>"
          class="exam-answer-input"
        />
        <span><%= a.text || a.value || a %></span>
      </label>
      <% }) %>
    </div>
    <% } %>

    <!-- Multiple Choice -->
    <% if (q.type === 'multiple_choice' && Array.isArray(q.answers)) { %>
    <div class="exam-question-options">
      <% q.answers.forEach(function(a, answerIndex){ %>
      <label class="exam-option">
        <input
          type="checkbox"
          name="answers[<%= q._id %>][]"
          value="<%= answerIndex %>"
          class="exam-answer-input exam-answer-checkbox"
        />
        <span><%= a.text || a.value || a %></span>
      </label>
      <% }) %>
    </div>
    <% } %>

    <!-- True/False -->
    <% if (q.type === 'true_false' && Array.isArray(q.answers)) { %>
    <div class="exam-question-truefalse">
      <% q.answers.forEach(function(a, answerIndex){ %>
      <label class="exam-option exam-option-truefalse">
        <input
          type="radio"
          name="answers[<%= q._id %>]"
          value="<%= a.value === true ? 'true' : 'false' %>"
          class="exam-answer-input"
        />
        <span class="exam-truefalse-label"><%= a.value === true ? '‚úÖ ƒê√∫ng' : '‚ùå Sai' %></span>
      </label>
      <% }) %>
    </div>
    <% } %>

    <!-- Fill in Blank -->
    <% if (q.type === 'fill_in_blank') { %>
    <div class="exam-question-fillblank">
      <input
        type="text"
        name="answers[<%= q._id %>]"
        class="exam-answer-input exam-answer-text"
        placeholder="<%= (q.answers && q.answers.placeholder) || 'Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n' %>"
      />
    </div>
    <% } %>

    <!-- Matching -->
    <% if (q.type === 'matching' && q.answers && q.answers.leftItems && q.answers.rightItems) { %>
    <div class="exam-question-matching">
      <div class="exam-matching-grid">
        <% q.answers.leftItems.forEach(function(leftItem, leftIndex){ %>
        <div class="exam-matching-row">
          <div class="exam-matching-left">
            <span class="exam-matching-number"><%= leftIndex + 1 %>.</span>
            <span class="exam-matching-item"><%= leftItem %></span>
          </div>
          <div class="exam-matching-right">
            <select name="answers[<%= q._id %>][<%= leftItem %>]" class="exam-answer-input exam-answer-select">
              <option value="">-- Ch·ªçn ƒë√°p √°n --</option>
              <% q.answers.rightItems.forEach(function(rightItem){ %>
              <option value="<%= rightItem %>"><%= rightItem %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <% }) %>
      </div>
    </div>
    <% } %>

  </div>
  <% }) %>

  <div class="exam-actions">
    <button type="submit" class="btn btn-primary">N·ªôp b√†i</button>
  </div>
</form>
<% } %>

<script src="/static/js/exam-take.js"></script>
<%- include("../partical/footer") %>
