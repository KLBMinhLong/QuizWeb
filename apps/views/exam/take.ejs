<%- include("../partical/header", { title: "Làm bài" }) %>

<!-- Breadcrumb (US-41) -->
<nav class="breadcrumb">
  <a href="/" class="breadcrumb__item">Trang chủ</a>
  <span class="breadcrumb__separator">›</span>
  <a href="/subjects" class="breadcrumb__item">Môn học</a>
  <span class="breadcrumb__separator">›</span>
  <% if (subject && subject.slug) { %>
  <a href="/subjects/<%= subject.slug %>" class="breadcrumb__item"><%= subject.name %></a>
  <span class="breadcrumb__separator">›</span>
  <% } %>
  <span class="breadcrumb__item breadcrumb__item--current">Làm bài</span>
</nav>

<div class="page-header">
  <h1 class="page-title">Làm bài<% if (subject && subject.name) { %>: <%= subject.name %><% } %></h1>
</div>

<% if (hasShortage) { %>
<div class="alert alert-warning" style="margin-bottom: var(--spacing-xl);">
  ⚠️ Ngân hàng câu hỏi hiện không đủ theo cấu hình đề. Hệ thống đã lấy tối đa số câu có thể cho mỗi độ khó.
</div>
<% } %>

<% if (!questions || questions.length === 0) { %>
<div class="card">
  <p>Chưa đủ câu hỏi trong ngân hàng cho môn này.</p>
</div>
<% } else { %>

<!-- Timer (US-41) -->
<div id="exam-timer" class="exam-timer">
  <div class="exam-timer-content">
    <span class="exam-timer-label">⏱️ Thời gian còn lại:</span>
    <span id="exam-timer-text" class="exam-timer-text">00:00</span>
  </div>
  <div id="exam-timer-warning" class="exam-timer-warning" style="display: none;">
    Thời gian sắp hết! Hãy nộp bài sớm.
  </div>
</div>

<form 
  id="exam-form" 
  method="post" 
  action="/exam/submit" 
  class="card"
  data-duration-minutes="<%= durationMinutes %>"
  data-attempt-id="<%= attemptId %>"
  data-total-questions="<%= questions.length %>"
>
  <input type="hidden" name="subjectId" value="<%= subjectId %>" />
  <input type="hidden" name="attemptId" value="<%= attemptId %>" />

  <% questions.forEach(function(q, idx){ %>
  <div class="exam-question">
    <div class="exam-question-header">
      <span class="badge">Câu <%= idx + 1 %></span>
      <span class="badge badge-secondary"><%= q.difficulty %></span>
      <% if (q.type) { %>
      <span class="badge badge-info" style="font-size: 12px;"><%= q.type %></span>
      <% } %>
    </div>
    <div class="exam-question-content"><%= q.content %></div>

    <% if (Array.isArray(q.answers)) { %>
    <div class="exam-question-options">
      <% q.answers.forEach(function(a, answerIndex){ %>
      <label class="exam-option">
        <input
          type="radio"
          name="answers[<%= q._id %>]"
          value="<%= answerIndex %>"
        />
        <span><%= a.text || a.value || a %></span>
      </label>
      <% }) %>
    </div>
    <% } else { %>
    <div class="exam-question-note">
      Loại câu hỏi này sẽ hỗ trợ ở phiên bản sau.
    </div>
    <% } %>
  </div>
  <% }) %>

  <div class="exam-actions">
    <button type="submit" class="btn btn-primary">Nộp bài</button>
  </div>
</form>
<% } %>

<script src="/static/js/exam-take.js"></script>
<%- include("../partical/footer") %>
