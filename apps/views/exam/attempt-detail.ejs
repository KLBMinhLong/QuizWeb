<%- include("../partical/header", { title: "Chi tiết bài thi" }) %>

  <nav class="breadcrumb">
    <a href="/" class="breadcrumb__item">Trang chủ</a>
    <span class="breadcrumb__separator">›</span>
    <a href="/exam/history" class="breadcrumb__item">Lịch sử thi</a>
    <span class="breadcrumb__separator">›</span>
    <span class="breadcrumb__item breadcrumb__item--current">Chi tiết</span>
  </nav>

  <div class="page-header">
    <h1 class="page-title">Chi tiết bài thi</h1>
    <p class="page-subtitle">
      <%= subject.name %>
    </p>
  </div>

  <!-- Score Summary -->
  <div class="card" style="margin-bottom: var(--spacing-xl)">
    <div class="attempt-summary">
      <div class="attempt-stat attempt-stat--primary">
        <div class="attempt-stat__value attempt-stat__value--xl">
          <%= attempt.score !==null ? attempt.score : '-' %>
        </div>
        <div class="attempt-stat__label">Điểm số</div>
      </div>
      <div class="attempt-stat">
        <div class="attempt-stat__value attempt-stat__value--lg attempt-stat__value--success">
          <%= questionDetails.filter(q=> q.isCorrect).length %>
        </div>
        <div class="attempt-stat__label">Câu đúng</div>
      </div>
      <div class="attempt-stat">
        <div class="attempt-stat__value attempt-stat__value--lg">
          <%= attempt.totalQuestions %>
        </div>
        <div class="attempt-stat__label">Tổng số câu</div>
      </div>
      <div class="attempt-stat">
        <div class="attempt-stat__value attempt-stat__value--lg">
          <%= attempt.durationMinutes %>
        </div>
        <div class="attempt-stat__label">Phút</div>
      </div>
    </div>
  </div>

  <!-- Question Details -->
  <div class="card">
    <h2 style="margin-bottom: var(--spacing-lg)">Chi tiết từng câu</h2>

    <% questionDetails.forEach(function(detail) { const question=detail.question; const userAnswer=detail.userAnswer;
      const isCorrect=detail.isCorrect; %>
      <div class="review-question">
        <div class="review-question__header">
          <span class="badge">Câu <%= detail.index %></span>
          <span class="badge badge-secondary">
            <%= question.difficulty %>
          </span>
          <% if (isCorrect) { %>
            <span class="badge badge-success">Đúng</span>
            <% } else { %>
              <span class="badge badge-danger">Sai</span>
              <% } %>
        </div>

        <div class="review-question__content">
          <%= question.content %>
        </div>

        <% if (question.mediaUrl) { %>
          <div class="exam-question-media">
            <img src="<%= question.mediaUrl %>" alt="Hình ảnh câu hỏi" class="exam-media-image">
          </div>
          <% } %>

            <% if (question.type==='single_choice' || question.type==='multiple_choice' ) { %>
              <!-- Choice Questions -->
              <div class="review-options">
                <% (question.answers || []).forEach(function(answer, answerIndex) { const isUserAnswer=userAnswer
                  !==undefined && userAnswer !==null && Number(userAnswer)===answerIndex; const
                  isCorrectAnswer=answer.isCorrect===true; let optionClass='' ; if (isCorrectAnswer) {
                  optionClass='review-option--correct' ; } else if (isUserAnswer && !isCorrect) {
                  optionClass='review-option--wrong' ; } %>
                  <div class="review-option <%= optionClass %>">
                    <span class="review-option__text">
                      <%= answer.text %>
                    </span>
                    <% if (isCorrectAnswer) { %>
                      <span class="review-option__badge review-option__badge--correct">Đáp án đúng</span>
                      <% } %>
                  </div>
                  <% }) %>
              </div>

              <% } else if (question.type==='true_false' ) { %>
                <!-- True/False Questions -->
                <div class="review-options">
                  <% (question.answers || []).forEach(function(answer, answerIndex) { const isUserAnswer=userAnswer
                    !==undefined && userAnswer !==null && Number(userAnswer)===answerIndex; const
                    isCorrectAnswer=answer.isCorrect===true; let optionClass='' ; if (isCorrectAnswer) {
                    optionClass='review-option--correct' ; } else if (isUserAnswer && !isCorrect) {
                    optionClass='review-option--wrong' ; } %>
                    <div class="review-option <%= optionClass %>">
                      <span class="review-option__text">
                        <%= answer.value ? 'Đúng' : 'Sai' %>
                      </span>
                      <% if (isCorrectAnswer) { %>
                        <span class="review-option__badge review-option__badge--correct">Đáp án đúng</span>
                        <% } %>
                    </div>
                    <% }) %>
                </div>

                <% } else if (question.type==='fill_in_blank' ) { %>
                  <!-- Fill in Blank -->
                  <div class="review-fill">
                    <div
                      class="review-fill__answer <%= isCorrect ? 'review-fill__answer--correct' : 'review-fill__answer--wrong' %>">
                      <div class="review-fill__label"><strong>Câu trả lời của bạn:</strong></div>
                      <div class="review-fill__value">
                        <% if (userAnswer !==undefined && userAnswer !==null && userAnswer !=='' ) { %>
                          <%= userAnswer %>
                            <% } else { %>
                              <span style="color: var(--color-text-muted); font-style: italic;">(Không trả lời)</span>
                              <% } %>
                      </div>
                      <div
                        class="review-fill__result <%= isCorrect ? 'review-fill__result--correct' : 'review-fill__result--wrong' %>">
                        <%= isCorrect ? 'Chính xác' : 'Không chính xác' %>
                      </div>
                    </div>

                    <div class="review-fill__accepted">
                      <div class="review-fill__label"><strong>Đáp án được chấp nhận:</strong></div>
                      <% if (question.answers && question.answers.accepted && question.answers.accepted.length> 0) { %>
                        <div class="review-fill__accepted-list">
                          <% question.answers.accepted.forEach(function(acceptedAnswer) { %>
                            <span class="review-fill__accepted-item">
                              <%= acceptedAnswer %>
                            </span>
                            <% }) %>
                        </div>
                        <% } else { %>
                          <span style="color: var(--color-text-muted); font-style: italic;">Không có đáp án</span>
                          <% } %>
                    </div>
                  </div>

                  <% } else if (question.type==='matching' ) { %>
                    <!-- Matching Questions -->
                    <% const userPairs={}; if (userAnswer && typeof userAnswer==='object' ) { if
                      (Array.isArray(userAnswer)) { userAnswer.forEach(pair=> {
                      if (pair.left && pair.right) {
                      userPairs[pair.left] = pair.right;
                      }
                      });
                      } else {
                      Object.assign(userPairs, userAnswer);
                      }
                      }
                      const correctPairs = question.answers && question.answers.pairs ? question.answers.pairs : [];
                      %>
                      <div class="review-matching">
                        <% correctPairs.forEach(function(correctPair) { const userRight=userPairs[correctPair.left];
                          const isPairCorrect=userRight===correctPair.right; const hasUserAnswer=userRight !==undefined
                          && userRight !==null; %>
                          <div
                            class="review-matching__pair <%= isPairCorrect ? 'review-matching__pair--correct' : (hasUserAnswer ? 'review-matching__pair--wrong' : '') %>">
                            <div class="review-matching__left">
                              <div class="review-matching__left-label"><strong>Nối từ:</strong></div>
                              <div class="review-matching__left-value">
                                <%= correctPair.left %>
                              </div>
                            </div>

                            <span class="review-matching__arrow">→</span>

                            <div class="review-matching__right">
                              <% if (hasUserAnswer) { %>
                                <div class="review-matching__user-answer">
                                  <div class="review-matching__answer-label"><strong>Bạn đã nối với:</strong></div>
                                  <span
                                    class="review-matching__answer-box <%= isPairCorrect ? 'review-matching__answer-box--correct' : 'review-matching__answer-box--wrong' %>">
                                    <%= userRight %>
                                  </span>
                                </div>
                                <% } else { %>
                                  <div class="review-matching__user-answer">
                                    <div class="review-matching__answer-label"><strong>Bạn đã nối với:</strong></div>
                                    <span style="color: var(--color-text-muted); font-style: italic;">(Không trả
                                      lời)</span>
                                  </div>
                                  <% } %>

                                    <% if (!isPairCorrect) { %>
                                      <div>
                                        <div class="review-matching__answer-label"><strong>Đáp án đúng:</strong></div>
                                        <span class="review-matching__correct-answer">
                                          <%= correctPair.right %>
                                        </span>
                                      </div>
                                      <% } %>
                            </div>
                          </div>
                          <% }) %>
                      </div>

                      <% if (!isCorrect) { %>
                        <div class="review-matching__status review-matching__status--wrong">
                          Có một số cặp nối chưa chính xác
                        </div>
                        <% } else { %>
                          <div class="review-matching__status review-matching__status--correct">
                            Tất cả các cặp nối đều chính xác
                          </div>
                          <% } %>

                            <% } else { %>
                              <div style="color: var(--color-text-muted); font-style: italic;">
                                Loại câu hỏi này chưa hỗ trợ hiển thị chi tiết.
                              </div>
                              <% } %>
      </div>
      <% }) %>
  </div>

  <div class="attempt-back">
    <a href="/exam/history" class="btn btn-secondary">Quay lại lịch sử thi</a>
  </div>

  <%- include("../partical/footer") %>