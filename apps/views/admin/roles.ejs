<%- include('./partials/header', { pageTitle: 'Quản lý phân quyền' , activePage: 'roles' , breadcrumb: 'Phân quyền' ,
  user: typeof user !=='undefined' ? user : null }) %>

  <% if (typeof error !=='undefined' && error) { %>
    <div class="alert alert-error">
      <%= error %>
    </div>
    <% } %>

      <% if (typeof success !=='undefined' && success) { %>
        <div class="alert alert-success">
          <% if (success==='created' ) { %>
            ✓ Đã tạo role thành công!
            <% } else if (success==='updated' ) { %>
              ✓ Đã cập nhật role thành công!
              <% } else if (success==='deleted' ) { %>
                ✓ Đã xoá role thành công!
                <% } else { %>
                  <%= success %>
                    <% } %>
        </div>
        <% } %>

          <div class="admin-content__header">
            <div>
              <h1 class="admin-content__title">Quản lý phân quyền</h1>
              <p class="admin-content__subtitle">Tạo và quản lý roles, permissions trong hệ thống</p>
            </div>
            <div class="admin-content__actions">
              <button type="button" class="admin-btn admin-btn--primary" onclick="showCreateModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Tạo role mới
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="admin-stats-grid"
            style="grid-template-columns: repeat(2, 1fr); margin-bottom: var(--spacing-2xl);">
            <div class="admin-stat-card">
              <div class="admin-stat-card__icon admin-stat-card__icon--orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
              </div>
              <div class="admin-stat-card__content">
                <div class="admin-stat-card__value">
                  <%= roles ? roles.length : 0 %>
                </div>
                <div class="admin-stat-card__label">Tổng roles</div>
              </div>
            </div>

            <div class="admin-stat-card">
              <div class="admin-stat-card__icon admin-stat-card__icon--purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="admin-stat-card__content">
                <div class="admin-stat-card__value">
                  <%= roles ? roles.reduce((sum, r)=> sum + (r.userCount || 0), 0) : 0 %>
                </div>
                <div class="admin-stat-card__label">Tổng users được gán role</div>
              </div>
            </div>
          </div>

          <!-- Roles List -->
          <div class="admin-panel">
            <div class="admin-panel__header">
              <h3 class="admin-panel__title">
                Danh sách roles
                <span class="admin-panel__count">
                  <%= roles ? roles.length : 0 %>
                </span>
              </h3>
            </div>

            <% if (!roles || roles.length===0) { %>
              <div class="admin-panel__body">
                <div class="admin-empty">
                  <div class="admin-empty__icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                  </div>
                  <div class="admin-empty__title">Chưa có role nào</div>
                  <div class="admin-empty__text">Bấm "Tạo role mới" để thêm role đầu tiên</div>
                </div>
              </div>
              <% } else { %>
                <div class="admin-panel__body admin-panel__body--no-padding">
                  <table class="admin-table">
                    <thead>
                      <tr>
                        <th>Tên role</th>
                        <th>Mô tả</th>
                        <th style="text-align: center;">Số users</th>
                        <th>Ngày tạo</th>
                        <th style="text-align: center;">Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% roles.forEach(function(role) { %>
                        <tr>
                          <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <div
                                style="width: 36px; height: 36px; background: linear-gradient(135deg, #ea580c, #f97316); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                                  style="width: 18px; height: 18px;">
                                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                              </div>
                              <div>
                                <code
                                  style="background: var(--color-primary-soft); padding: 4px 8px; border-radius: 4px; font-weight: 600;"><%= role.name %></code>
                                <% if (role.normalizedName==='ADMIN' ) { %>
                                  <span class="admin-badge admin-badge--danger"
                                    style="margin-left: 8px; font-size: 10px;">Protected</span>
                                  <% } %>
                              </div>
                            </div>
                          </td>
                          <td style="color: var(--color-text-muted);">
                            <%= role.description || '-' %>
                          </td>
                          <td style="text-align: center;">
                            <span style="font-weight: 700; color: var(--color-primary); font-size: 18px;">
                              <%= role.userCount || 0 %>
                            </span>
                          </td>
                          <td style="color: var(--color-text-muted); font-size: 14px;">
                            <%= role.createdAt ? new Date(role.createdAt).toLocaleDateString('vi-VN') : '-' %>
                          </td>
                          <td>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                              <button type="button" class="admin-btn admin-btn--primary admin-btn--sm"
                                onclick="managePermissions('<%= role._id %>', '<%= role.name %>')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                Permissions
                              </button>
                              <button type="button" class="admin-btn admin-btn--secondary admin-btn--sm"
                                data-id="<%= role._id %>" data-name="<%= (role.name || '').replace(/" /g, '&quot;'
                                ).replace(/'/g, '&#39;' ) %>"
                                data-description="<%= (role.description || '' ).replace(/"/g, '&quot;'
                                  ).replace(/'/g, '&#39;' ) %>"
                                  onclick="showEditModal(this)">
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                  </svg>
                                  Sửa
                              </button>
                              <% if (role.normalizedName !=='ADMIN' && (role.userCount || 0)===0) { %>
                                <form method="post" action="/admin/roles/<%= role._id %>/delete"
                                  style="display: inline;" onsubmit="return confirm('Bạn có chắc muốn xoá role này?')">
                                  <button type="submit" class="admin-btn admin-btn--danger admin-btn--sm">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                      <polyline points="3 6 5 6 21 6"></polyline>
                                      <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                      </path>
                                    </svg>
                                    Xoá
                                  </button>
                                </form>
                                <% } else { %>
                                  <button type="button" class="admin-btn admin-btn--secondary admin-btn--sm" disabled
                                    style="opacity: 0.5; cursor: not-allowed;"
                                    title="<%= role.normalizedName === 'ADMIN' ? 'Không thể xoá role admin' : 'Không thể xoá role đang được sử dụng' %>">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                      <polyline points="3 6 5 6 21 6"></polyline>
                                      <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                      </path>
                                    </svg>
                                    Xoá
                                  </button>
                                  <% } %>
                            </div>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </div>
                <% } %>
          </div>

          <!-- Modal: Tạo role mới -->
          <div id="createModal" class="admin-modal">
            <div class="admin-modal__content" style="max-width: 500px;">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Tạo role mới</h3>
                <button type="button" class="admin-modal__close" onclick="closeCreateModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <form method="post" action="/admin/roles/create">
                <div class="admin-modal__body">
                  <div class="admin-form-group">
                    <label class="admin-form-label">Tên role *</label>
                    <input type="text" name="name" class="admin-form-input" placeholder="Ví dụ: editor, reviewer"
                      required pattern="[a-zA-Z0-9_]+" title="Chỉ chứa chữ, số và dấu gạch dưới" />
                    <small style="color: var(--color-text-muted); font-size: 12px; margin-top: 4px; display: block;">
                      Chỉ chứa chữ, số và dấu gạch dưới (2-50 ký tự)
                    </small>
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">Mô tả</label>
                    <textarea name="description" class="admin-form-input" rows="3"
                      placeholder="Mô tả về quyền của role này..."></textarea>
                  </div>
                </div>
                <div class="admin-modal__footer">
                  <button type="button" class="admin-btn admin-btn--secondary" onclick="closeCreateModal()">Hủy</button>
                  <button type="submit" class="admin-btn admin-btn--primary">Tạo role</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Modal: Sửa role -->
          <div id="editModal" class="admin-modal">
            <div class="admin-modal__content" style="max-width: 500px;">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Sửa role</h3>
                <button type="button" class="admin-modal__close" onclick="closeEditModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <form id="editForm" method="post" action="">
                <input type="hidden" name="roleId" id="editRoleId" />
                <div class="admin-modal__body">
                  <div class="admin-form-group">
                    <label class="admin-form-label">Tên role *</label>
                    <input type="text" name="name" id="editRoleName" class="admin-form-input" required
                      pattern="[a-zA-Z0-9_]+" />
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">Mô tả</label>
                    <textarea name="description" id="editRoleDescription" class="admin-form-input" rows="3"></textarea>
                  </div>
                </div>
                <div class="admin-modal__footer">
                  <button type="button" class="admin-btn admin-btn--secondary" onclick="closeEditModal()">Hủy</button>
                  <button type="submit" class="admin-btn admin-btn--primary">Lưu thay đổi</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Modal: Manage Permissions -->
          <div id="permissionsModal" class="admin-modal">
            <div class="admin-modal__content" style="max-width: 700px;">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Quản lý Permissions: <span id="permissionsRoleName"></span></h3>
                <button type="button" class="admin-modal__close" onclick="closePermissionsModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="admin-modal__body">
                <div id="permissionsLoading"
                  style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                  Đang tải...
                </div>

                <div id="permissionsContent" style="display: none;">
                  <!-- Current Permissions -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <h4
                      style="margin-bottom: var(--spacing-md); color: var(--color-text-main); font-size: 14px; font-weight: 600;">
                      Permissions hiện tại</h4>
                    <div id="currentPermissions" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px;">
                      <p style="color: var(--color-text-muted); width: 100%;">Chưa có permission nào</p>
                    </div>
                  </div>

                  <!-- Add Permission -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <h4
                      style="margin-bottom: var(--spacing-md); color: var(--color-text-main); font-size: 14px; font-weight: 600;">
                      Thêm permission</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
                      <select id="permissionSelect" class="admin-form-select">
                        <option value="">-- Chọn permission --</option>
                      </select>
                      <button type="button" class="admin-btn admin-btn--primary" onclick="addPermission()"
                        style="white-space: nowrap;">
                        Thêm
                      </button>
                    </div>
                  </div>

                  <!-- Available Permissions by Category -->
                  <div>
                    <h4
                      style="margin-bottom: var(--spacing-md); color: var(--color-text-main); font-size: 14px; font-weight: 600;">
                      Danh sách permissions</h4>
                    <div id="availablePermissions"
                      style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                      <!-- Will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <script>
            function showCreateModal() {
              document.getElementById('createModal').classList.add('admin-modal--active');
            }
            function closeCreateModal() {
              document.getElementById('createModal').classList.remove('admin-modal--active');
            }

            function showEditModal(btn) {
              const id = btn.dataset.id;
              const name = btn.dataset.name;
              const description = btn.dataset.description;

              document.getElementById('editRoleId').value = id;
              document.getElementById('editRoleName').value = name;
              document.getElementById('editRoleDescription').value = description || '';
              document.getElementById('editForm').action = '/admin/roles/' + id + '/update';
              document.getElementById('editModal').classList.add('admin-modal--active');
            }
            function closeEditModal() {
              document.getElementById('editModal').classList.remove('admin-modal--active');
            }

            // ===== Permissions Management =====
            let currentRoleId = null;
            let currentClaims = [];
            let availablePermissions = [];

            function managePermissions(roleId, roleName) {
              currentRoleId = roleId;
              document.getElementById('permissionsRoleName').textContent = roleName;
              document.getElementById('permissionsModal').classList.add('admin-modal--active');
              document.getElementById('permissionsLoading').style.display = 'block';
              document.getElementById('permissionsContent').style.display = 'none';

              fetch(`/admin/roles/${roleId}/claims`)
                .then(res => res.json())
                .then(data => {
                  if (data.ok) {
                    currentClaims = data.claims || [];
                    availablePermissions = data.availablePermissions || [];
                    renderPermissions(data);
                  } else {
                    alert('Lỗi: ' + data.message);
                    closePermissionsModal();
                  }
                })
                .catch(err => {
                  console.error('Error loading permissions:', err);
                  alert('Lỗi khi tải permissions');
                  closePermissionsModal();
                });
            }

            function renderPermissions(data) {
              document.getElementById('permissionsLoading').style.display = 'none';
              document.getElementById('permissionsContent').style.display = 'block';

              const currentPermsDiv = document.getElementById('currentPermissions');
              if (currentClaims.length === 0) {
                currentPermsDiv.innerHTML = '<p style="color: var(--color-text-muted); width: 100%;">Chưa có permission nào</p>';
              } else {
                currentPermsDiv.innerHTML = currentClaims.map(claim => {
                  const perm = availablePermissions.find(p => p.value === claim.claimValue);
                  return `
        <span class="admin-badge admin-badge--info" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;">
          ${perm ? perm.label : claim.claimValue}
          <button type="button" onclick="removePermission('${claim._id}')" style="background: none; border: none; color: currentColor; cursor: pointer; padding: 0; font-size: 14px; opacity: 0.7;" title="Xóa permission">✕</button>
        </span>
      `;
                }).join('');
              }

              const select = document.getElementById('permissionSelect');
              const currentValues = currentClaims.map(c => c.claimValue);
              const available = availablePermissions.filter(p => !currentValues.includes(p.value));

              select.innerHTML = '<option value="">-- Chọn permission --</option>' +
                available.map(p => `<option value="${p.value}">${p.label} (${p.value})</option>`).join('');

              const availableDiv = document.getElementById('availablePermissions');
              const byCategory = {};
              availablePermissions.forEach(perm => {
                if (!byCategory[perm.category]) {
                  byCategory[perm.category] = [];
                }
                byCategory[perm.category].push(perm);
              });

              availableDiv.innerHTML = Object.keys(byCategory).map(category => {
                const perms = byCategory[category];
                return `
      <div style="border: 1px solid rgba(0,0,0,0.1); border-radius: var(--radius-sm); padding: var(--spacing-md);">
        <h5 style="margin: 0 0 var(--spacing-sm) 0; color: var(--color-text-main); font-size: 14px;">${category}</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
          ${perms.map(perm => {
                  const isActive = currentValues.includes(perm.value);
                  return `
              <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px;
                background: ${isActive ? 'var(--color-primary-soft)' : 'transparent'};
                color: ${isActive ? 'var(--color-primary-dark)' : 'var(--color-text-muted)'};
                border: 1px solid ${isActive ? 'var(--color-primary)' : 'rgba(0,0,0,0.1)'};
              ">${perm.label}</span>
            `;
                }).join('')}
        </div>
      </div>
    `;
              }).join('');
            }

            function addPermission() {
              const select = document.getElementById('permissionSelect');
              const permissionValue = select.value;

              if (!permissionValue) {
                alert('Vui lòng chọn permission');
                return;
              }

              fetch(`/admin/roles/${currentRoleId}/claims/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `claimType=permission&claimValue=${encodeURIComponent(permissionValue)}`
              })
                .then(res => res.json())
                .then(data => {
                  if (data.ok) {
                    managePermissions(currentRoleId, document.getElementById('permissionsRoleName').textContent);
                  } else {
                    alert('Lỗi: ' + data.message);
                  }
                })
                .catch(err => {
                  console.error('Error adding permission:', err);
                  alert('Lỗi khi thêm permission');
                });
            }

            function removePermission(claimId) {
              if (!confirm('Bạn có chắc muốn xóa permission này?')) return;

              fetch(`/admin/roles/${currentRoleId}/claims/${claimId}/remove`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                  if (data.ok) {
                    managePermissions(currentRoleId, document.getElementById('permissionsRoleName').textContent);
                  } else {
                    alert('Lỗi: ' + data.message);
                  }
                })
                .catch(err => {
                  console.error('Error removing permission:', err);
                  alert('Lỗi khi xóa permission');
                });
            }

            function closePermissionsModal() {
              document.getElementById('permissionsModal').classList.remove('admin-modal--active');
              currentRoleId = null;
              currentClaims = [];
            }

            // Close modals when clicking outside
            document.querySelectorAll('.admin-modal').forEach(modal => {
              modal.addEventListener('click', function (e) {
                if (e.target === this) {
                  this.classList.remove('admin-modal--active');
                }
              });
            });
          </script>

          <%- include('./partials/footer') %>