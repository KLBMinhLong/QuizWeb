<%- include("../partical/header", { title: "Admin - Questions" }) %>

<!-- Breadcrumb -->
<nav class="breadcrumb">
  <a href="/" class="breadcrumb__item">Trang chủ</a>
  <span class="breadcrumb__separator">›</span>
  <a href="/admin" class="breadcrumb__item">Quản trị</a>
  <span class="breadcrumb__separator">›</span>
  <span class="breadcrumb__item breadcrumb__item--current">Quản lý câu hỏi</span>
</nav>

<div class="admin-header">
  <h1 class="admin-header__title">Quản lý câu hỏi</h1>
</div>

<% if (error) { %>
<div class="alert alert-error"><%= error %></div>
<% } %> 
<% if (success) { %>
<div class="alert alert-success"><%= success %></div>
<% } %>

<!-- Actions -->
<div class="card mt-xl">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <a href="/admin/questions/create" class="btn btn-primary">Tạo câu hỏi mới</a>
      <a href="/admin/questions/import" class="btn" style="margin-left: 0.5rem;">Import từ file</a>
    </div>
  </div>
</div>

<!-- Filter Form -->
<div class="card mt-xl">
  <h3 class="card__title">Lọc câu hỏi</h3>
  <form method="get" action="/admin/questions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
    <div class="form-group">
      <label class="form-label">Môn học</label>
      <select name="subjectId" class="form-input">
        <option value="">Tất cả môn học</option>
        <% if (subjects && subjects.length > 0) { %>
          <% subjects.forEach(function(s) { %>
            <option value="<%= s._id %>" <%= filters && filters.subjectId === String(s._id) ? "selected" : "" %>><%= s.name %></option>
          <% }) %>
        <% } %>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">Độ khó</label>
      <select name="difficulty" class="form-input">
        <option value="">Tất cả</option>
        <option value="easy" <%= filters && filters.difficulty === "easy" ? "selected" : "" %>>Dễ</option>
        <option value="medium" <%= filters && filters.difficulty === "medium" ? "selected" : "" %>>Trung bình</option>
        <option value="hard" <%= filters && filters.difficulty === "hard" ? "selected" : "" %>>Khó</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">Loại câu hỏi</label>
      <select name="type" class="form-input">
        <option value="">Tất cả</option>
        <option value="single_choice" <%= filters && filters.type === "single_choice" ? "selected" : "" %>>Trắc nghiệm một lựa chọn</option>
        <option value="multiple_choice" <%= filters && filters.type === "multiple_choice" ? "selected" : "" %>>Trắc nghiệm nhiều lựa chọn</option>
        <option value="true_false" <%= filters && filters.type === "true_false" ? "selected" : "" %>>Đúng/Sai</option>
        <option value="fill_in_blank" <%= filters && filters.type === "fill_in_blank" ? "selected" : "" %>>Điền từ</option>
        <option value="matching" <%= filters && filters.type === "matching" ? "selected" : "" %>>Nối cặp</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">Tìm kiếm</label>
      <input type="text" name="keyword" value="<%= filters && filters.keyword ? filters.keyword : '' %>" placeholder="Tìm trong nội dung..." class="form-input" />
    </div>
    
    <div class="form-group">
      <button type="submit" class="btn btn-primary" style="width: 100%;">Lọc</button>
      <a href="/admin/questions" class="btn" style="width: 100%; margin-top: 0.5rem;">Xóa bộ lọc</a>
    </div>
  </form>
</div>

<!-- Questions List -->
<div class="card mt-xl">
  <h3 class="card__title">Danh sách câu hỏi (<%= questions ? questions.length : 0 %>)</h3>
  <% if (!questions || questions.length === 0) { %>
  <p class="card__content" style="color: var(--color-text-muted)">
    Chưa có câu hỏi nào.
  </p>
  <% } else { %>
  <div style="overflow-x: auto">
    <table class="data-table">
      <thead>
        <tr>
          <th>Nội dung</th>
          <th>Môn học</th>
          <th>Độ khó</th>
          <th>Loại</th>
          <th style="text-align: center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <% questions.forEach(function(q){ %>
        <tr>
          <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            <%= q.content %>
          </td>
          <td>
            <% if (q.subject) { %>
              <span style="font-weight: 600"><%= q.subject.name %></span>
            <% } else { %>
              <span style="color: #999;">N/A</span>
            <% } %>
          </td>
          <td>
            <% 
              const difficultyLabels = { easy: "Dễ", medium: "Trung bình", hard: "Khó" };
              const difficultyColors = { easy: "#16a34a", medium: "#ea580c", hard: "#dc2626" };
              const difficultyBg = { easy: "#dcfce7", medium: "#fff7ed", hard: "#fee2e2" };
            %>
            <span style="background: <%= difficultyBg[q.difficulty] || '#f3f4f6' %>; color: <%= difficultyColors[q.difficulty] || '#6b7280' %>; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
              <%= difficultyLabels[q.difficulty] || q.difficulty %>
            </span>
          </td>
          <td>
            <% 
              const typeLabels = {
                single_choice: "Trắc nghiệm 1 lựa chọn",
                multiple_choice: "Trắc nghiệm nhiều lựa chọn",
                true_false: "Đúng/Sai",
                fill_in_blank: "Điền từ",
                matching: "Nối cặp"
              };
            %>
            <span style="font-size: 13px;"><%= typeLabels[q.type] || q.type %></span>
          </td>
          <td style="text-align: center">
            <a href="/admin/questions/<%= q._id %>/edit" class="btn" style="padding: 0.4rem 0.8rem; font-size: 13px;">Sửa</a>
            <form method="post" action="/admin/questions/<%= q._id %>/delete" style="display: inline-block; margin-left: 0.5rem;" onsubmit="return confirm('Bạn có chắc chắn muốn xóa câu hỏi này?');">
              <button type="submit" class="btn" style="padding: 0.4rem 0.8rem; font-size: 13px; background: #fee2e2; color: #dc2626; border-color: #fecaca;">Xóa</button>
            </form>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>

<%- include("../partical/footer") %>
