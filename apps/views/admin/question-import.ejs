<%- include("../partical/header", { title: "Admin - Import C√¢u h·ªèi" }) %>

<style>
/* Loading Overlay */
.import-loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.import-loading-overlay.active {
  display: flex;
}

.import-loading-content {
  background: white;
  padding: 2rem 3rem;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 400px;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.import-loading-spinner {
  width: 60px;
  height: 60px;
  margin: 0 auto 1.5rem;
  position: relative;
}

.import-loading-spinner::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border: 4px solid #e5e7eb;
  border-top-color: #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.import-loading-text {
  font-size: 1.2rem;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.5rem;
}

.import-loading-subtext {
  font-size: 0.9rem;
  color: #6b7280;
  margin-top: 0.5rem;
}

.import-loading-progress {
  margin-top: 1rem;
  height: 4px;
  background: #e5e7eb;
  border-radius: 2px;
  overflow: hidden;
}

.import-loading-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
  width: 0%;
  animation: progress 2s ease-in-out infinite;
  background-size: 200% 100%;
}

@keyframes progress {
  0% {
    width: 0%;
    background-position: 0% 50%;
  }
  50% {
    width: 70%;
    background-position: 100% 50%;
  }
  100% {
    width: 100%;
    background-position: 0% 50%;
  }
}

/* Fun animations */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

.import-loading-icon {
  font-size: 3rem;
  animation: bounce 2s infinite;
  margin-bottom: 1rem;
  display: inline-block;
}

/* Fun floating animation for icon */
@keyframes float {
  0%, 100% {
    transform: translateY(0) rotate(0deg);
  }
  25% {
    transform: translateY(-10px) rotate(-5deg);
  }
  75% {
    transform: translateY(-5px) rotate(5deg);
  }
}

.import-loading-icon {
  animation: float 3s ease-in-out infinite;
}
</style>

<!-- Loading Overlay -->
<div id="importLoadingOverlay" class="import-loading-overlay">
  <div class="import-loading-content">
    <div class="import-loading-icon">üìö</div>
    <div class="import-loading-spinner"></div>
    <div class="import-loading-text">ƒêang import c√¢u h·ªèi...</div>
    <div class="import-loading-subtext" id="loadingStatus">
      ƒêang x·ª≠ l√Ω file c·ªßa b·∫°n, vui l√≤ng ƒë·ª£i trong gi√¢y l√°t
    </div>
    <div class="import-loading-progress">
      <div class="import-loading-progress-bar"></div>
    </div>
  </div>
</div>

<script>
// Show loading overlay when form is submitted
document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form[action='/admin/questions/import']");
  const overlay = document.getElementById("importLoadingOverlay");
  const statusText = document.getElementById("loadingStatus");
  
  const messages = [
    { text: "ƒêang ƒë·ªçc file...", icon: "üìñ" },
    { text: "ƒêang ki·ªÉm tra d·ªØ li·ªáu...", icon: "üîç" },
    { text: "ƒêang validate c√¢u h·ªèi...", icon: "‚úì" },
    { text: "ƒêang l∆∞u v√†o database...", icon: "üíæ" },
    { text: "S·∫Øp ho√†n t·∫•t...", icon: "‚ú®" }
  ];
  
  const funFacts = [
    "üí° M·∫πo: B·∫°n c√≥ th·ªÉ import h√†ng trƒÉm c√¢u h·ªèi c√πng l√∫c!",
    "üìö C√¢u h·ªèi ƒë∆∞·ª£c l∆∞u v√†o ng√¢n h√†ng ƒë·ªÅ thi an to√†n",
    "‚ö° H·ªá th·ªëng t·ª± ƒë·ªông ki·ªÉm tra v√† validate d·ªØ li·ªáu",
    "üéØ M·ªói c√¢u h·ªèi ƒë∆∞·ª£c ph√¢n lo·∫°i theo ƒë·ªô kh√≥ v√† lo·∫°i",
    "üöÄ Import nhanh ch√≥ng v√† hi·ªáu qu·∫£!"
  ];
  
  let messageIndex = 0;
  let factIndex = 0;
  
  if (form && overlay) {
    form.addEventListener("submit", function(e) {
      overlay.classList.add("active");
      const iconElement = document.querySelector(".import-loading-icon");
      
      // Change status message and icon every 1.5 seconds
      const messageInterval = setInterval(function() {
        if (messageIndex < messages.length) {
          const msg = messages[messageIndex];
          statusText.textContent = msg.text;
          if (iconElement) {
            iconElement.textContent = msg.icon;
          }
          messageIndex++;
        } else {
          // Show fun facts after processing messages
          const fact = funFacts[factIndex % funFacts.length];
          statusText.textContent = fact;
          if (iconElement) {
            iconElement.textContent = fact.split(" ")[0]; // Get emoji from fact
          }
          factIndex++;
        }
      }, 1500);
      
      // Clean up interval when page unloads (in case of redirect)
      window.addEventListener("beforeunload", function() {
        clearInterval(messageInterval);
      });
    });
  }
});
</script>

<!-- Breadcrumb -->
<nav class="breadcrumb">
  <a href="/" class="breadcrumb__item">Trang ch·ªß</a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <a href="/admin" class="breadcrumb__item">Qu·∫£n tr·ªã</a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <a href="/admin/questions" class="breadcrumb__item">Qu·∫£n l√Ω c√¢u h·ªèi</a>
  <span class="breadcrumb__separator">‚Ä∫</span>
  <span class="breadcrumb__item breadcrumb__item--current">Import c√¢u h·ªèi</span>
</nav>

<div class="admin-header">
  <h1 class="admin-header__title">Import c√¢u h·ªèi t·ª´ file</h1>
</div>

<!-- Success/Error Messages -->
<% if (success) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (error) { %>
  <div class="alert alert-error"><%= error %></div>
<% } %>

<!-- Import Form -->
<div class="card mt-xl">
  <h2 class="card__title">Import c√¢u h·ªèi t·ª´ file</h2>
  <div class="card__content">
    <form method="post" action="/admin/questions/import" enctype="multipart/form-data">
      <div class="form-group">
        <label class="form-label">Ch·ªçn file Excel (.xlsx, .xls) ho·∫∑c CSV (.csv):</label>
        <input type="file" name="file" id="file" accept=".xlsx,.xls,.csv" required class="form-input" />
      </div>
      <button type="submit" class="btn btn-primary">Import</button>
      <a href="/admin/questions" class="btn" style="margin-left: 0.5rem;">H·ªßy</a>
    </form>
  </div>
</div>

<!-- H∆∞·ªõng d·∫´n -->
<div class="card mt-xl">
  <h3 class="card__title">ƒê·ªãnh d·∫°ng file</h3>
  <div class="card__content">
    <p>File Excel ph·∫£i c√≥ sheet t√™n <strong>"Questions"</strong> (ho·∫∑c sheet ƒë·∫ßu ti√™n) v·ªõi c√°c c·ªôt:</p>
    <ul style="line-height: 1.8; margin-left: 1.5rem;">
      <li><strong>subjectSlug</strong>: Slug c·ªßa m√¥n h·ªçc (v√≠ d·ª•: "toan-hoc")</li>
      <li><strong>difficulty</strong>: ƒê·ªô kh√≥ (easy, medium, hard)</li>
      <li><strong>type</strong>: Lo·∫°i c√¢u h·ªèi (single_choice, multiple_choice, true_false, fill_in_blank, matching)</li>
      <li><strong>content</strong>: N·ªôi dung c√¢u h·ªèi</li>
      <li><strong>answersJson</strong>: JSON string c·ªßa ƒë√°p √°n (xem v√≠ d·ª• b√™n d∆∞·ªõi)</li>
      <li><strong>mediaUrl</strong> (t√πy ch·ªçn): URL h√¨nh ·∫£nh/video</li>
    </ul>
    
    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">V√≠ d·ª• answersJson:</h4>
    <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
      <div style="margin-bottom: 0.5rem;"><strong>single_choice/multiple_choice:</strong></div>
      <div>[{"text":"ƒê√°p √°n A","isCorrect":true},{"text":"ƒê√°p √°n B","isCorrect":false}]</div>
      <div style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>true_false:</strong></div>
      <div>[{"value":true,"isCorrect":true},{"value":false,"isCorrect":false}]</div>
      <div style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>fill_in_blank:</strong></div>
      <div>{"accepted":["ƒë√°p √°n 1","ƒë√°p √°n 2"]}</div>
      <div style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>matching:</strong></div>
      <div>{"pairs":[{"left":"A","right":"1"},{"left":"B","right":"2"}]}</div>
    </div>
  </div>
</div>

<!-- Import Errors Details -->
<% if (importErrors && importErrors.length > 0) { %>
  <div class="card mt-xl" style="background-color: #fff3cd; border-color: #ffeaa7;">
    <h3 class="card__title">Chi ti·∫øt l·ªói:</h3>
    <div class="card__content">
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>D√≤ng</th>
              <th>L·ªói</th>
            </tr>
          </thead>
          <tbody>
            <% importErrors.forEach(function(err) { %>
              <tr>
                <td><strong><%= err.row %></strong></td>
                <td><%= err.message %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% } %>

<%- include("../partical/footer") %>

