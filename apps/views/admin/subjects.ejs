<%- include("../partical/header", { title: "Admin - Subjects" }) %>

<!-- Breadcrumb -->
<nav class="breadcrumb">
  <a href="/" class="breadcrumb__item">Trang chủ</a>
  <span class="breadcrumb__separator">›</span>
  <a href="/admin" class="breadcrumb__item">Quản trị</a>
  <span class="breadcrumb__separator">›</span>
  <span class="breadcrumb__item breadcrumb__item--current"
    >Quản lý môn học</span
  >
</nav>

<div class="admin-header">
  <h1 class="admin-header__title">Quản lý môn học</h1>
</div>

<% if (error) { %>
<div class="alert alert-error"><%= error %></div>
<% } %> <% if (success) { %>
<div class="alert alert-success"><%= success %></div>
<% } %>

<div class="card mt-xl">
  <h3 class="card__title">Tạo môn học mới</h3>
  <form method="post" action="/admin/subjects/create">
    <div class="form-group">
      <label class="form-label">Tên môn học</label>
      <input
        name="name"
        class="form-input"
        placeholder="Ví dụ: Lịch sử Việt Nam"
        required
      />
    </div>
    <div class="form-group">
      <label class="form-label">Mô tả</label>
      <textarea
        name="description"
        class="form-textarea"
        placeholder="Mô tả ngắn về môn học..."
      ></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Tạo môn học</button>
  </form>
</div>

<div class="card mt-xl">
  <h3 class="card__title">Danh sách môn học</h3>
  <% if (!subjects || subjects.length === 0) { %>
  <p class="card__content" style="color: var(--color-text-muted)">
    Chưa có môn học nào.
  </p>
  <% } else { %>
  <div style="overflow-x: auto">
    <table class="data-table">
      <thead>
        <tr>
          <th>Tên môn</th>
          <th>Slug</th>
          <th>Trạng thái</th>
          <th>Cấu hình</th>
          <th style="text-align: center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <% subjects.forEach(function(s){ %>
        <tr>
          <td style="font-weight: 600"><%= s.name %></td>
          <td>
            <code
              style="
                background: var(--color-primary-soft);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 13px;
              "
              ><%= s.slug %></code
            >
          </td>
          <td>
            <% if (s.isActive) { %>
            <span
              style="
                background: #dcfce7;
                color: #16a34a;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
              "
              >Hiển thị</span
            >
            <% } else { %>
            <span
              style="
                background: #fee2e2;
                color: #dc2626;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
              "
              >Ẩn</span
            >
            <% } %>
          </td>
          <td style="font-size: 13px; color: var(--color-text-muted)">
            Dễ: <%= s.examConfig?.easyCount || 0 %> | TB: <%=
            s.examConfig?.mediumCount || 0 %> | Khó: <%= s.examConfig?.hardCount
            || 0 %> | <%= s.examConfig?.durationMinutes || 0 %> phút
          </td>
          <td style="text-align: center">
            <button
              onclick="showEditModal('<%= String(s._id) %>', '<%= s.name %>', '<%= s.description || '' %>')"
              class="btn btn-secondary"
              style="padding: 6px 12px; font-size: 13px; margin: 2px"
            >
              Sửa
            </button>
            <button
              onclick="showConfigModal('<%= String(s._id) %>', <%= s.examConfig?.easyCount || 0 %>, <%= s.examConfig?.mediumCount || 0 %>, <%= s.examConfig?.hardCount || 0 %>, <%= s.examConfig?.durationMinutes || 0 %>)"
              class="btn btn-secondary"
              style="padding: 6px 12px; font-size: 13px; margin: 2px"
            >
              Cấu hình
            </button>
            <form
              method="post"
              action="/admin/subjects/<%= String(s._id) %>/toggle-active"
              style="display: inline"
            >
              <input type="hidden" name="isActive" value="<%= !s.isActive %>" />
              <button
                type="submit"
                class="btn btn-secondary"
                style="padding: 6px 12px; font-size: 13px; margin: 2px"
              >
                <%= s.isActive ? 'Ẩn' : 'Hiện' %>
              </button>
            </form>
            <form
              method="post"
              action="/admin/subjects/<%= String(s._id) %>/delete"
              style="display: inline"
              onsubmit="return confirm('Bạn có chắc muốn xóa môn học này?')"
            >
              <button
                type="submit"
                class="btn"
                style="
                  background: #dc2626;
                  color: white;
                  padding: 6px 12px;
                  font-size: 13px;
                  margin: 2px;
                  border-radius: var(--radius-full);
                "
              >
                Xóa
              </button>
            </form>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>

<!-- Modal sửa môn học -->
<div
  id="editModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="card"
    style="max-width: 500px; margin: 20px; max-height: 90vh; overflow-y: auto"
  >
    <h3 class="card__title">Chỉnh sửa môn học</h3>
    <form id="editForm" method="post">
      <div class="form-group">
        <label class="form-label">Tên môn học</label>
        <input id="editName" name="name" class="form-input" required />
      </div>
      <div class="form-group">
        <label class="form-label">Mô tả</label>
        <textarea
          id="editDescription"
          name="description"
          class="form-textarea"
        ></textarea>
      </div>
      <div style="display: flex; gap: 12px">
        <button type="submit" class="btn btn-primary">Cập nhật</button>
        <button
          type="button"
          onclick="closeEditModal()"
          class="btn btn-secondary"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal cấu hình đề thi -->
<div
  id="configModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="card"
    style="max-width: 500px; margin: 20px; max-height: 90vh; overflow-y: auto"
  >
    <h3 class="card__title">Cấu hình đề thi</h3>
    <form id="configForm" method="post">
      <div class="form-group">
        <label class="form-label">Số câu dễ</label>
        <input
          id="configEasy"
          name="easyCount"
          type="number"
          min="0"
          class="form-input"
          required
        />
      </div>
      <div class="form-group">
        <label class="form-label">Số câu trung bình</label>
        <input
          id="configMedium"
          name="mediumCount"
          type="number"
          min="0"
          class="form-input"
          required
        />
      </div>
      <div class="form-group">
        <label class="form-label">Số câu khó</label>
        <input
          id="configHard"
          name="hardCount"
          type="number"
          min="0"
          class="form-input"
          required
        />
      </div>
      <div class="form-group">
        <label class="form-label">Thời gian (phút)</label>
        <input
          id="configDuration"
          name="durationMinutes"
          type="number"
          min="1"
          class="form-input"
          required
        />
      </div>
      <div style="display: flex; gap: 12px">
        <button type="submit" class="btn btn-primary">Cập nhật</button>
        <button
          type="button"
          onclick="closeConfigModal()"
          class="btn btn-secondary"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</div>

<script src="/static/js/admin-subjects.js"></script>

<%- include("../partical/footer") %>
