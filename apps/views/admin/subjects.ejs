<%- include('./partials/header', { pageTitle: 'Quản lý môn học' , activePage: 'subjects' , breadcrumb: 'Môn học' , user:
  typeof user !=='undefined' ? user : null }) %>

  <% if (typeof error !=='undefined' && error) { %>
    <div class="alert alert-error">
      <%= error %>
    </div>
    <% } %>
      <% if (typeof success !=='undefined' && success) { %>
        <div class="alert alert-success">
          <%= success %>
        </div>
        <% } %>

          <div class="admin-content__header">
            <div>
              <h1 class="admin-content__title">Quản lý môn học</h1>
              <p class="admin-content__subtitle">Tạo và quản lý các môn học trong hệ thống</p>
            </div>
            <div class="admin-content__actions">
              <button type="button" class="admin-btn admin-btn--primary" onclick="showCreateModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Tạo môn học mới
              </button>
            </div>
          </div>

          <div class="admin-stats-grid" style="margin-bottom: var(--spacing-2xl);">
            <div class="admin-stat-card">
              <div class="admin-stat-card__icon admin-stat-card__icon--green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
              </div>
              <div class="admin-stat-card__content">
                <div class="admin-stat-card__value">
                  <%= subjects ? subjects.length : 0 %>
                </div>
                <div class="admin-stat-card__label">Tổng môn học</div>
              </div>
            </div>

            <div class="admin-stat-card">
              <div class="admin-stat-card__icon admin-stat-card__icon--blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
              </div>
              <div class="admin-stat-card__content">
                <div class="admin-stat-card__value">
                  <%= subjects ? subjects.filter(s=> s.isActive).length : 0 %>
                </div>
                <div class="admin-stat-card__label">Đang hoạt động</div>
              </div>
            </div>
          </div>

          <div class="admin-panel">
            <div class="admin-panel__header">
              <h3 class="admin-panel__title">
                Danh sách môn học
                <span class="admin-panel__count">
                  <%= subjects ? subjects.length : 0 %>
                </span>
              </h3>
            </div>

            <% if (!subjects || subjects.length===0) { %>
              <div class="admin-panel__body">
                <div class="admin-empty">
                  <div class="admin-empty__icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                  </div>
                  <div class="admin-empty__title">Chưa có môn học nào</div>
                  <div class="admin-empty__text">Bấm "Tạo môn học mới" để thêm môn học đầu tiên</div>
                </div>
              </div>
              <% } else { %>
                <div class="admin-panel__body admin-panel__body--no-padding">
                  <table class="admin-table">
                    <thead>
                      <tr>
                        <th>Môn học</th>
                        <th>Slug</th>
                        <th>Trạng thái</th>
                        <th>Cấu hình đề thi</th>
                        <th style="text-align: center;">Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% subjects.forEach(function(s) { %>
                        <tr>
                          <td>
                            <div class="admin-table__cell-main">
                              <%= s.name %>
                            </div>
                            <% if (s.description) { %>
                              <div class="admin-table__cell-sub">
                                <%= s.description.substring(0, 60) %>
                                  <%= s.description.length> 60 ? '...' : '' %>
                              </div>
                              <% } %>
                          </td>
                          <td>
                            <code
                              style="background: var(--color-primary-soft); padding: 4px 8px; border-radius: 4px; font-size: 13px;"><%= s.slug %></code>
                          </td>
                          <td>
                            <% if (s.isActive) { %>
                              <span class="admin-badge admin-badge--success">Hiển thị</span>
                              <% } else { %>
                                <span class="admin-badge admin-badge--danger">Ẩn</span>
                                <% } %>
                          </td>
                          <td>
                            <div style="font-size: 13px; color: var(--color-text-muted);">
                              <span style="color: #16a34a;">Dễ: <%= s.examConfig?.easyCount || 0 %></span> •
                              <span style="color: #d97706;">TB: <%= s.examConfig?.mediumCount || 0 %></span> •
                              <span style="color: #dc2626;">Khó: <%= s.examConfig?.hardCount || 0 %></span>
                              <br>
                              <span>⏱ <%= s.examConfig?.durationMinutes || 0 %> phút</span>
                            </div>
                          </td>
                          <td>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                              <button type="button" class="admin-btn admin-btn--secondary admin-btn--sm"
                                data-id="<%= String(s._id) %>" data-name="<%= s.name %>"
                                data-description="<%= s.description || '' %>" onclick="showEditModal(this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Sửa
                              </button>

                              <button type="button" class="admin-btn admin-btn--secondary admin-btn--sm"
                                onclick="showConfigModal('<%= String(s._id) %>', <%= s.examConfig?.easyCount || 0 %>, <%= s.examConfig?.mediumCount || 0 %>, <%= s.examConfig?.hardCount || 0 %>, <%= s.examConfig?.durationMinutes || 0 %>)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <circle cx="12" cy="12" r="3"></circle>
                                  <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33">
                                  </path>
                                </svg>
                                Cấu hình
                              </button>

                              <form method="post" action="/admin/subjects/<%= String(s._id) %>/toggle-active"
                                style="display: inline;">
                                <input type="hidden" name="isActive" value="<%= !s.isActive %>" />
                                <button type="submit" class="admin-btn admin-btn--secondary admin-btn--sm">
                                  <% if (s.isActive) { %>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                      <path
                                        d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                                      </path>
                                      <line x1="1" y1="1" x2="23" y2="23"></line>
                                    </svg>
                                    Ẩn
                                    <% } else { %>
                                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                      </svg>
                                      Hiện
                                      <% } %>
                                </button>
                              </form>

                              <form method="post" action="/admin/subjects/<%= String(s._id) %>/delete"
                                style="display: inline;" onsubmit="return confirm('Bạn có chắc muốn xóa môn học này?')">
                                <button type="submit" class="admin-btn admin-btn--danger admin-btn--sm">
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                  </svg>
                                  Xóa
                                </button>
                              </form>
                            </div>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </div>
                <% } %>
          </div>

          <div id="createModal" class="admin-modal">
            <div class="admin-modal__content">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Tạo môn học mới</h3>
                <button type="button" class="admin-modal__close" onclick="closeCreateModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <form method="post" action="/admin/subjects/create">
                <div class="admin-modal__body">
                  <div class="admin-form-group">
                    <label class="admin-form-label">Tên môn học *</label>
                    <input type="text" name="name" class="admin-form-input" placeholder="Ví dụ: Lịch sử Việt Nam"
                      required />
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">Mô tả</label>
                    <textarea name="description" class="admin-form-input" rows="3"
                      placeholder="Mô tả ngắn về môn học..."></textarea>
                  </div>
                </div>
                <div class="admin-modal__footer">
                  <button type="button" class="admin-btn admin-btn--secondary" onclick="closeCreateModal()">Hủy</button>
                  <button type="submit" class="admin-btn admin-btn--primary">Tạo môn học</button>
                </div>
              </form>
            </div>
          </div>

          <div id="editModal" class="admin-modal">
            <div class="admin-modal__content">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Chỉnh sửa môn học</h3>
                <button type="button" class="admin-modal__close" onclick="closeEditModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <form id="editForm" method="post" action="">
                <div class="admin-modal__body">
                  <div class="admin-form-group">
                    <label class="admin-form-label">Tên môn học *</label>
                    <input type="text" name="name" id="editName" class="admin-form-input" required />
                  </div>
                  <div class="admin-form-group">
                    <label class="admin-form-label">Mô tả</label>
                    <textarea name="description" id="editDescription" class="admin-form-input" rows="3"></textarea>
                  </div>
                </div>
                <div class="admin-modal__footer">
                  <button type="button" class="admin-btn admin-btn--secondary" onclick="closeEditModal()">Hủy</button>
                  <button type="submit" class="admin-btn admin-btn--primary">Lưu thay đổi</button>
                </div>
              </form>
            </div>
          </div>

          <div id="configModal" class="admin-modal">
            <div class="admin-modal__content">
              <div class="admin-modal__header">
                <h3 class="admin-modal__title">Cấu hình đề thi</h3>
                <button type="button" class="admin-modal__close" onclick="closeConfigModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <form id="configForm" method="post" action="">
                <div class="admin-modal__body">
                  <div class="admin-form-inline">
                    <div class="admin-form-group">
                      <label class="admin-form-label">Số câu dễ</label>
                      <input type="number" name="easyCount" id="configEasy" class="admin-form-input" min="0" required />
                    </div>
                    <div class="admin-form-group">
                      <label class="admin-form-label">Số câu trung bình</label>
                      <input type="number" name="mediumCount" id="configMedium" class="admin-form-input" min="0"
                        required />
                    </div>
                  </div>
                  <div class="admin-form-inline">
                    <div class="admin-form-group">
                      <label class="admin-form-label">Số câu khó</label>
                      <input type="number" name="hardCount" id="configHard" class="admin-form-input" min="0" required />
                    </div>
                    <div class="admin-form-group">
                      <label class="admin-form-label">Thời gian (phút)</label>
                      <input type="number" name="durationMinutes" id="configDuration" class="admin-form-input" min="1"
                        required />
                    </div>
                  </div>
                </div>
                <div class="admin-modal__footer">
                  <button type="button" class="admin-btn admin-btn--secondary" onclick="closeConfigModal()">Hủy</button>
                  <button type="submit" class="admin-btn admin-btn--primary">Lưu cấu hình</button>
                </div>
              </form>
            </div>
          </div>

          <script>
            function showCreateModal() {
              document.getElementById('createModal').classList.add('admin-modal--active');
            }
            function closeCreateModal() {
              document.getElementById('createModal').classList.remove('admin-modal--active');
            }

            function showEditModal(btn) {
              const id = btn.dataset.id;
              const name = btn.dataset.name;
              const description = btn.dataset.description;

              document.getElementById('editName').value = name;
              document.getElementById('editDescription').value = description;
              document.getElementById('editForm').action = '/admin/subjects/' + id + '/update';
              document.getElementById('editModal').classList.add('admin-modal--active');
            }
            function closeEditModal() {
              document.getElementById('editModal').classList.remove('admin-modal--active');
            }

            function showConfigModal(id, easy, medium, hard, duration) {
              document.getElementById('configEasy').value = easy;
              document.getElementById('configMedium').value = medium;
              document.getElementById('configHard').value = hard;
              document.getElementById('configDuration').value = duration;
              document.getElementById('configForm').action = '/admin/subjects/' + id + '/update-config';
              document.getElementById('configModal').classList.add('admin-modal--active');
            }
            function closeConfigModal() {
              document.getElementById('configModal').classList.remove('admin-modal--active');
            }

            document.querySelectorAll('.admin-modal').forEach(modal => {
              modal.addEventListener('click', function (e) {
                if (e.target === this) {
                  this.classList.remove('admin-modal--active');
                }
              });
            });
          </script>

          <%- include('./partials/footer') %>