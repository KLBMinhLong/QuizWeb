<%- include('./partials/header', { pageTitle: 'S·ª≠a c√¢u h·ªèi' , activePage: 'question-edit' , breadcrumb: 'S·ª≠a' , user:
  typeof user !=='undefined' ? user : null }) %>

  <% if (typeof error !=='undefined' && error) { %>
    <div class="alert alert-error">
      <%= error %>
    </div>
    <% } %>

      <div class="admin-content__header">
        <div>
          <h1 class="admin-content__title">S·ª≠a c√¢u h·ªèi</h1>
          <p class="admin-content__subtitle">Ch·ªânh s·ª≠a th√¥ng tin c√¢u h·ªèi trong ng√¢n h√†ng ƒë·ªÅ</p>
        </div>
        <div class="admin-content__actions">
          <a href="/admin/questions" class="admin-btn admin-btn--secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Quay l·∫°i
          </a>
        </div>
      </div>

      <div class="admin-panel">
        <div class="admin-panel__header">
          <h3 class="admin-panel__title">Th√¥ng tin c√¢u h·ªèi</h3>
        </div>
        <div class="admin-panel__body">
          <form method="post" action="/admin/questions/<%= question._id %>/update" enctype="multipart/form-data">
            <input type="hidden" id="answers-json" name="answers" value="<%= JSON.stringify(question.answers) %>" />

            <div class="admin-form-inline">
              <div class="admin-form-group">
                <label class="admin-form-label">M√¥n h·ªçc <span style="color: #dc2626;">*</span></label>
                <select name="subjectId" id="subjectId" class="admin-form-select" required>
                  <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                  <% if (subjects && subjects.length> 0) { %>
                    <% subjects.forEach(function(s) { %>
                      <option value="<%= s._id %>" <%=String(question.subjectId)===String(s._id) ? 'selected' : '' %>>
                        <%= s.name %>
                      </option>
                      <% }) %>
                        <% } %>
                </select>
              </div>

              <div class="admin-form-group">
                <label class="admin-form-label">ƒê·ªô kh√≥ <span style="color: #dc2626;">*</span></label>
                <select name="difficulty" id="difficulty" class="admin-form-select" required>
                  <option value="easy" <%=question.difficulty==='easy' ? 'selected' : '' %>>D·ªÖ</option>
                  <option value="medium" <%=question.difficulty==='medium' ? 'selected' : '' %>>Trung b√¨nh</option>
                  <option value="hard" <%=question.difficulty==='hard' ? 'selected' : '' %>>Kh√≥</option>
                </select>
              </div>

              <div class="admin-form-group">
                <label class="admin-form-label">Lo·∫°i c√¢u h·ªèi <span style="color: #dc2626;">*</span></label>
                <select name="type" id="type" class="admin-form-select" required>
                  <option value="">-- Ch·ªçn lo·∫°i c√¢u h·ªèi --</option>
                  <option value="single_choice" <%=question.type==='single_choice' ? 'selected' : '' %>>Tr·∫Øc nghi·ªám m·ªôt
                    l·ª±a ch·ªçn</option>
                  <option value="multiple_choice" <%=question.type==='multiple_choice' ? 'selected' : '' %>>Tr·∫Øc nghi·ªám
                    nhi·ªÅu l·ª±a ch·ªçn</option>
                  <option value="true_false" <%=question.type==='true_false' ? 'selected' : '' %>>ƒê√∫ng/Sai</option>
                  <option value="fill_in_blank" <%=question.type==='fill_in_blank' ? 'selected' : '' %>>ƒêi·ªÅn t·ª´</option>
                  <option value="matching" <%=question.type==='matching' ? 'selected' : '' %>>N·ªëi c·∫∑p</option>
                </select>
              </div>
            </div>

            <div class="admin-form-group">
              <label class="admin-form-label">N·ªôi dung c√¢u h·ªèi <span style="color: #dc2626;">*</span></label>
              <textarea name="content" id="content" class="admin-form-input" rows="4" required
                style="resize: vertical;"><%= question.content %></textarea>
            </div>

            <div class="admin-form-group">
              <label class="admin-form-label">H√¨nh ·∫£nh minh h·ªça (t√πy ch·ªçn)</label>

              <% if (question.mediaUrl) { %>
                <div id="currentImage"
                  style="margin-bottom: 0.75rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                  <p style="font-size: 13px; color: var(--color-text-muted); margin-bottom: 0.5rem;">H√¨nh ·∫£nh hi·ªán t·∫°i:
                  </p>
                  <img src="<%= question.mediaUrl %>" alt="Current image"
                    style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #e2e8f0;" />
                  <div style="margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="checkbox" name="removeImage" value="true" style="width: 16px; height: 16px;"
                        onchange="toggleCurrentImage(this)" />
                      <span style="color: #dc2626; font-size: 13px;">X√≥a h√¨nh ·∫£nh n√†y</span>
                    </label>
                  </div>
                </div>
                <% } %>

                  <div style="display: flex; align-items: center; gap: 1rem;">
                    <input type="file" name="questionImage" id="questionImage" accept="image/*" class="admin-form-input"
                      style="flex: 1;" onchange="previewImage(this)" />
                  </div>
                  <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
                    <p style="font-size: 13px; color: var(--color-text-muted); margin-bottom: 0.25rem;">H√¨nh ·∫£nh m·ªõi:
                    </p>
                    <img id="previewImg" src="" alt="Preview"
                      style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #e2e8f0;" />
                  </div>
                  <p style="font-size: 13px; color: var(--color-text-muted); margin-top: 6px;">
                    üì∑ H·ªó tr·ª£: JPG, PNG, GIF, WebP. T·ªëi ƒëa 5MB. ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi.
                  </p>
            </div>

            <div class="admin-form-group" id="answers-container">
              <!-- Dynamic answers fields will be inserted here -->
            </div>

            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
              <button type="submit" class="admin-btn admin-btn--primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                C·∫≠p nh·∫≠t
              </button>
              <a href="/admin/questions" class="admin-btn admin-btn--secondary">H·ªßy</a>
            </div>
          </form>
        </div>
      </div>

      <script>
        window.isEditMode = true;
      </script>
      <script src="/static/js/admin-questions.js"></script>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const question = JSON.parse('<%- JSON.stringify(question) %>');
          const typeSelect = document.getElementById("type");

          if (typeSelect && question.type) {
            typeSelect.dispatchEvent(new Event("change"));

            setTimeout(function () {
              loadExistingAnswers(question.type, question.answers);
            }, 100);
          }
        });

        function loadExistingAnswers(type, answers) {
          if (!answers) return;

          switch (type) {
            case "single_choice":
            case "multiple_choice": {
              const list = document.getElementById("choice-answers-list");
              if (!list) return;
              list.innerHTML = "";

              if (Array.isArray(answers)) {
                answers.forEach(function (ans) {
                  addChoiceAnswer(ans.text || '', ans.isCorrect || false);
                });
              }

              if (list.children.length === 0) {
                addChoiceAnswer('', false);
                addChoiceAnswer('', false);
              }
              break;
            }
            case "true_false": {
              if (Array.isArray(answers)) {
                const correctAnswer = answers.find(a => a.isCorrect);
                if (correctAnswer !== undefined) {
                  const valueToCheck = correctAnswer.value === true ? "true" : "false";
                  const radio = document.querySelector('input[name="tf-correct"][value="' + valueToCheck + '"]');
                  if (radio) radio.checked = true;
                }
              }
              break;
            }
            case "fill_in_blank": {
              const textarea = document.getElementById("fill-answers");
              if (textarea && answers.accepted && Array.isArray(answers.accepted)) {
                textarea.value = answers.accepted.join("\n");
              }
              break;
            }
            case "matching": {
              const list = document.getElementById("matching-pairs-list");
              if (!list) return;
              list.innerHTML = "";

              if (answers.pairs && Array.isArray(answers.pairs)) {
                answers.pairs.forEach(function (pair) {
                  addMatchingPair(pair.left || '', pair.right || '');
                });
              }

              if (list.children.length === 0) {
                addMatchingPair('', '');
                addMatchingPair('', '');
              }
              break;
            }
          }
        }

        function previewImage(input) {
          const preview = document.getElementById('imagePreview');
          const previewImg = document.getElementById('previewImg');

          if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
              previewImg.src = e.target.result;
              preview.style.display = 'block';
            };

            reader.readAsDataURL(input.files[0]);
          } else {
            preview.style.display = 'none';
            previewImg.src = '';
          }
        }

        function toggleCurrentImage(checkbox) {
          const currentImage = document.getElementById('currentImage');
          if (currentImage) {
            const img = currentImage.querySelector('img');
            if (img) {
              img.style.opacity = checkbox.checked ? '0.3' : '1';
              img.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
            }
          }
        }
      </script>

      <%- include('./partials/footer') %>